# ğŸ“‹ AtualizaÃ§Ã£o: AssociaÃ§Ã£o de Metas a Habilidades

**Data da AtualizaÃ§Ã£o:** 2024 (Revisado Janeiro 2026)  
**VersÃ£o:** 2.1  
**Status:** âœ… Implementado com ValidaÃ§Ãµes Aprimoradas

## ğŸ“Œ Resumo Executivo

Este documento descreve as alteraÃ§Ãµes implementadas para vincular cada meta (goal) Ã s habilidades (competÃªncias) que ela desenvolve atravÃ©s de uma relaÃ§Ã£o many-to-many via tabela `meta_habilidades`.

**Objetivo Principal:**  
Cada meta de PDI agora deve estar associada a uma ou mais habilidades do cargo do usuÃ¡rio que serÃ£o desenvolvidas ao completar a meta.

---

## ğŸ—„ï¸ AlteraÃ§Ãµes de Banco de Dados

### Nova Tabela: `meta_habilidades`

```sql
create table public.meta_habilidades (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  id_meta bigint null,
  id_habilidade bigint null,
  id_user bigint null,
  constraint meta_habilidades_pkey primary key (id),
  constraint meta_habilidades_id_habilidade_fkey foreign key (id_habilidade) references habilidades_cargo (id),
  constraint meta_habilidades_id_meta_fkey foreign key (id_meta) references metas_pdi (id),
  constraint meta_habilidades_id_user_fkey foreign key (id_user) references usuarios (id)
) tablespace pg_default;
```

**PropÃ³sito:** Tabela de junÃ§Ã£o que vincula metas Ã s habilidades que elas desenvolvem, com rastreamento do usuÃ¡rio.

---

## ğŸ”„ AlteraÃ§Ãµes por API

### 0. GET `/api/metas/habilidades-cargo/:id_cargo` - Listar Habilidades (metas.controller.js - buscarHabilidadesPorCargo) **[NOVO]**

#### âœ¨ Novo Endpoint

Este endpoint foi criado para ajudar a validar quais habilidades estÃ£o disponÃ­veis antes de criar uma meta.

**Request:**
```bash
curl -X GET "http://localhost:3000/api/metas/habilidades-cargo/1"
```

**Response (200 OK):**
```json
{
  "success": true,
  "message": "Habilidades do cargo buscadas com sucesso",
  "data": {
    "id_cargo": 1,
    "quantidade_habilidades": 5,
    "habilidades": [
      {
        "id": 1,
        "nome": "ComunicaÃ§Ã£o",
        "descricao": "Capacidade de se comunicar de forma clara e eficaz"
      },
      {
        "id": 2,
        "nome": "LideranÃ§a",
        "descricao": "Capacidade de liderar equipes"
      },
      {
        "id": 3,
        "nome": "Pensamento EstratÃ©gico",
        "descricao": "Capacidade de pensar estrategicamente"
      }
    ]
  }
}
```

**PropÃ³sito:** Permite que o frontend busque as habilidades vÃ¡lidas antes de criar uma meta, evitando erros de constraints de chave estrangeira.

---

### 1. POST `/api/metas` - Criar Meta (metas.controller.js - criarMeta)

#### âœ¨ AlteraÃ§Ãµes

**Novo Campo ObrigatÃ³rio no Request:**

```json
{
  "id_usuario": 5,
  "titulo_da_meta": "Melhorar habilidades de comunicaÃ§Ã£o",
  "atividades": ["Fazer curso de comunicaÃ§Ã£o", "Apresentar para o time"],
  "data_vencimento": "2025-03-31",
  "status": "Em Progresso",
  "id_usuarios": [5],
  "resultado_3_meses": "DescriÃ§Ã£o do resultado esperado",
  "resultado_6_meses": "DescriÃ§Ã£o do resultado esperado",
  "observacao_gestor": "ObservaÃ§Ãµes do gestor",
  "id_habilidades": [1, 3, 5]  // â† NOVO CAMPO OBRIGATÃ“RIO
}
```

**ValidaÃ§Ã£o Implementada:**

```javascript
if (!id_habilidades || !Array.isArray(id_habilidades) || id_habilidades.length === 0) {
  return res.status(400).json({
    success: false,
    error: 'MISSING_HABILIDADES',
    message: 'Array de habilidades Ã© obrigatÃ³rio e deve conter pelo menos uma habilidade a desenvolver'
  });
}
```

**AlteraÃ§Ãµes na TransaÃ§Ã£o (SeÃ§Ã£o 4 - NOVA):**

A API agora insere automaticamente os registros na tabela `meta_habilidades`:

```javascript
// 4. Inserir habilidades desenvolvidas
if (Array.isArray(meta.id_habilidades) && meta.id_habilidades.length > 0) {
  const metaHabilidadesQuery = `
    INSERT INTO meta_habilidades (
      id_meta, id_habilidade, id_user
    ) VALUES ($1, $2, $3)
  `;
  
  for (const idHabilidade of id_habilidades) {
    await client.query(metaHabilidadesQuery, [metaId, idHabilidade, id_usuario]);
  }
}
```

#### Response Alterado

**Novo Campo no Response:**

```json
{
  "success": true,
  "meta": {
    "id": 42,
    "id_usuario": 5,
    "titulo": "Melhorar habilidades de comunicaÃ§Ã£o",
    "status": "Em Progresso",
    "data_vencimento": "2025-03-31",
    "habilidades_desenvolvidas": [
      {
        "id": 1,
        "habilidade": "ComunicaÃ§Ã£o",
        "descricao": "Capacidade de se comunicar de forma clara e eficaz"
      },
      {
        "id": 3,
        "habilidade": "LideranÃ§a",
        "descricao": "Capacidade de liderar equipes"
      },
      {
        "id": 5,
        "habilidade": "ApresentaÃ§Ãµes",
        "descricao": "Habilidade em apresentaÃ§Ãµes pÃºblicas"
      }
    ],
    "atividades": [...],
    "pessoas_envolvidas": [...]
  }
}
```

---

### 2. GET `/api/metas/usuario/:id_usuario` - Buscar Metas do UsuÃ¡rio (metas.controller.js - buscarMetasPorUsuario)

#### âœ¨ AlteraÃ§Ãµes na Query

A query foi alterada para incluir um LEFT JOIN com a tabela `meta_habilidades` e `habilidades_cargo`:

```sql
SELECT 
  m.id,
  m.titulo,
  m.prazo,
  m.status,
  m.resultado_3_meses,
  m.resultado_6_meses,
  -- NOVO: Agregar habilidades desenvolvidas
  COALESCE(
    json_agg(
      DISTINCT jsonb_build_object(
        'id', hc.id,
        'habilidade', hc.habilidade,
        'descricao', hc.descricao
      )
    ) FILTER (WHERE hc.id IS NOT NULL),
    '[]'::json
  ) as habilidades_desenvolvidas
FROM metas_pdi m
-- ... outros joins ...
LEFT JOIN meta_habilidades mh ON m.id = mh.id_meta
LEFT JOIN habilidades_cargo hc ON mh.id_habilidade = hc.id
GROUP BY m.id, hu.id, hu.nivel, hu.created_at, hc.id, hc.habilidade, hc.descricao
```

#### Response Alterado

```json
{
  "success": true,
  "metas": [
    {
      "id": 42,
      "titulo": "Melhorar habilidades de comunicaÃ§Ã£o",
      "prazo": "2025-03-31",
      "status": "Em Progresso",
      "resultado_3_meses": "...",
      "resultado_6_meses": "...",
      "habilidades_desenvolvidas": [
        {
          "id": 1,
          "habilidade": "ComunicaÃ§Ã£o",
          "descricao": "Capacidade de se comunicar de forma clara e eficaz"
        },
        {
          "id": 3,
          "habilidade": "LideranÃ§a",
          "descricao": "Capacidade de liderar equipes"
        }
      ]
    }
  ]
}
```

---

### 3. GET `/api/habilidades-usuarios/usuario/:id_usuario` - Buscar Habilidades com Metas Associadas (habilidades_usuarios.controller.js - buscarHabilidadesPorUsuario)

#### âœ¨ AlteraÃ§Ãµes na Query

A query foi expandida para fazer LEFT JOIN com `meta_habilidades` e `metas_pdi`, permitindo retornar todas as metas associadas a cada habilidade:

```sql
SELECT 
  hc.id,
  hc.habilidade,
  hc.descricao,
  hu.nivel,
  hu.created_at,
  -- NOVO: Agregar todas as metas que desenvolvem esta habilidade
  COALESCE(
    json_agg(
      DISTINCT jsonb_build_object(
        'id', m.id,
        'titulo', m.titulo,
        'prazo', m.prazo,
        'status', m.status,
        'resultado_3_meses', m.resultado_3_meses,
        'resultado_6_meses', m.resultado_6_meses
      )
    ) FILTER (WHERE m.id IS NOT NULL),
    '[]'::json
  ) as metas_associadas
FROM habilidades_cargo hc
LEFT JOIN habilidades_usuarios hu ON hc.id = hu.id_habilidade
LEFT JOIN meta_habilidades mh ON hc.id = mh.id_habilidade AND mh.id_user = u.id
LEFT JOIN metas_pdi m ON mh.id_meta = m.id
WHERE hu.id_user = $1
GROUP BY hu.id, hu.nivel, hu.created_at, hc.id, hc.habilidade, hc.descricao
```

#### Response Alterado

```json
{
  "success": true,
  "habilidades": [
    {
      "id": 1,
      "titulo": "ComunicaÃ§Ã£o",
      "descricao": "Capacidade de se comunicar de forma clara e eficaz",
      "nivel": 3,
      "created_at": "2024-01-15T10:30:00Z",
      "metas_associadas": [
        {
          "id": 42,
          "titulo": "Melhorar habilidades de comunicaÃ§Ã£o",
          "prazo": "2025-03-31",
          "status": "Em Progresso",
          "resultado_3_meses": "...",
          "resultado_6_meses": "..."
        },
        {
          "id": 45,
          "titulo": "Desenvolver apresentaÃ§Ãµes de negÃ³cios",
          "prazo": "2025-06-30",
          "status": "Planejamento",
          "resultado_3_meses": "...",
          "resultado_6_meses": "..."
        }
      ]
    }
  ]
}
```

---

### 4. POST `/api/ia/gerar-pdi` - Gerar PDI com IA (ia.controller.js - gerarPDI)

#### âœ¨ AlteraÃ§Ãµes

**1. Busca de Habilidades do Cargo (NOVO)**

A IA agora busca todas as habilidades associadas ao cargo do usuÃ¡rio:

```javascript
let habilidadesCargoResult = { rows: [] };
const usuarioCargo = usuarioResult.rows[0] ? usuarioResult.rows[0].cargo : null;
if (usuarioCargo) {
  try {
    const habilidadesCargoQuery = `
      SELECT id, habilidade, descricao
      FROM habilidades_cargo
      WHERE id_cargo = $1
      ORDER BY habilidade
    `;
    habilidadesCargoResult = await client.query(habilidadesCargoQuery, [usuarioCargo]);
  } catch (queryError) {
    logger.warn('Erro ao buscar habilidades do cargo', { error: queryError.message, cargo: usuarioCargo });
  }
}
```

**2. Contexto Estendido para a IA (NOVO)**

O contexto enviado Ã  IA agora inclui a lista de habilidades que podem ser desenvolvidas:

```
ğŸ’¡ **HABILIDADES DO CARGO QUE PODE DESENVOLVER:**
- ComunicaÃ§Ã£o: Capacidade de se comunicar de forma clara e eficaz
- LideranÃ§a: Capacidade de liderar equipes
- Pensamento EstratÃ©gico: Capacidade de pensar estrategicamente
- GestÃ£o de Tempo: Capacidade de gerenciar o tempo eficientemente
...
```

**3. System Prompt Estendido (NOVO)**

A IA recebe instruÃ§Ãµes especÃ­ficas para mapear habilidades:

```
âš¡ **MAPEAMENTO DE HABILIDADES DO CARGO:**
Para cada meta que gerar, VOCÃŠ DEVE escolher 1-3 habilidades do cargo do [NOME_USUARIO] que aquela meta vai desenvolver.
As habilidades disponÃ­veis sÃ£o:
1. ID: 1 | Nome: ComunicaÃ§Ã£o | DescriÃ§Ã£o: Capacidade de se comunicar de forma clara e eficaz
2. ID: 3 | Nome: LideranÃ§a | DescriÃ§Ã£o: Capacidade de liderar equipes
3. ID: 5 | Nome: Pensamento EstratÃ©gico | DescriÃ§Ã£o: Capacidade de pensar estrategicamente
...

IMPORTANTE: Escolha IDs reais das habilidades acima. Cada meta deve estar linkada a pelo menos uma habilidade que ela vai desenvolver.
```

**4. ValidaÃ§Ã£o de id_habilidades (NOVO)**

A validaÃ§Ã£o agora verifica que cada meta possui um array `id_habilidades`:

```javascript
pdiGerado = pdiGerado
  .filter(meta => {
    const valido = meta.titulo && meta.titulo.trim() && 
                   Array.isArray(meta.atividades) && meta.atividades.length > 0 &&
                   Array.isArray(meta.id_habilidades) && meta.id_habilidades.length > 0;
    return valido;
  })
  .map(meta => ({
    titulo: meta.titulo || '',
    atividades: meta.atividades || [],
    prazo: meta.prazo || prazoMinString,
    status: 'Em Progresso',
    resultado_3_meses: meta.resultado_3_meses || null,
    resultado_6_meses: meta.resultado_6_meses || null,
    feedback_gestor: meta.feedback_gestor || '',
    id_habilidades: Array.isArray(meta.id_habilidades) ? meta.id_habilidades.filter(h => h && !isNaN(h)).map(h => parseInt(h)) : [],
    id_usuario: parseInt(id_user),
    id_usuarios: [parseInt(id_user)]
  }));
```

**5. Salvamento com Habilidades (NOVO)**

Ao salvar as metas geradas, a API agora insere os registros na tabela `meta_habilidades`:

```javascript
// 4. Inserir habilidades desenvolvidas
if (Array.isArray(meta.id_habilidades) && meta.id_habilidades.length > 0) {
  const habilidadesQuery = `
    INSERT INTO meta_habilidades (
      id_meta, id_habilidade, id_user
    ) VALUES ($1, $2, $3)
  `;
  
  for (const habilidadeId of meta.id_habilidades) {
    try {
      await client.query(habilidadesQuery, [metaId, habilidadeId, parseInt(id_user)]);
    } catch (hErr) {
      logger.warn('Erro ao inserir habilidade para meta', { 
        meta_id: metaId, 
        habilidade_id: habilidadeId, 
        error: hErr.message 
      });
    }
  }
}
```

#### JSON de Exemplo Agora Inclui

A IA recebe um exemplo com o novo campo `id_habilidades`:

```json
{
  "metas": [
    {
      "titulo": "Meta 1 clara e objetiva",
      "atividades": ["atividade 1", "atividade 2", "atividade 3"],
      "prazo": "2025-03-31",
      "status": "Em Progresso",
      "resultado_3_meses": "DescriÃ§Ã£o clara",
      "resultado_6_meses": "DescriÃ§Ã£o clara",
      "feedback_gestor": "InstruÃ§Ãµes prÃ¡ticas e especÃ­ficas",
      "id_habilidades": [1, 3, 5]
    }
  ]
}
```

#### Response da IA

A IA agora retorna metas com habilidades mapeadas:

```json
{
  "success": true,
  "id_user": 5,
  "pdi": [
    {
      "titulo": "Melhorar comunicaÃ§Ã£o em apresentaÃ§Ãµes",
      "atividades": ["Fazer curso de apresentaÃ§Ã£o", "Praticar apresentaÃ§Ãµes"],
      "prazo": "2025-03-31",
      "status": "Em Progresso",
      "resultado_3_meses": "Ter feito o curso e realizado 2 apresentaÃ§Ãµes",
      "resultado_6_meses": "Dominar tÃ©cnicas de apresentaÃ§Ã£o",
      "feedback_gestor": "Foco em tÃ©cnicas de apresentaÃ§Ã£o",
      "id_habilidades": [1, 5]
    },
    {
      "titulo": "Desenvolver lideranÃ§a de projeto",
      "atividades": ["Liderar projeto da equipe", "Fazer coaching de lideranÃ§a"],
      "prazo": "2025-06-30",
      "status": "Em Progresso",
      "resultado_3_meses": "Projeto iniciado com equipe alinhada",
      "resultado_6_meses": "Projeto concluÃ­do com sucesso",
      "feedback_gestor": "Oportunidade de exercitar lideranÃ§a",
      "id_habilidades": [3]
    }
  ],
  "total_metas": 2,
  "gerado_por": "OpenAI GPT-4o-mini"
}
```

---

## ï¿½ï¸ ValidaÃ§Ãµes de Habilidades (Novo - v2.1)

### ValidaÃ§Ã£o de ExistÃªncia

Quando vocÃª cria uma meta com `id_habilidades`, o sistema agora valida se todos os IDs existem na tabela `habilidades_cargo`:

```javascript
// Validar se as habilidades existem
const habilidadesCheckQuery = `
  SELECT id FROM habilidades_cargo WHERE id = ANY($1)
`;
const habilidadesCheckResult = await client.query(habilidadesCheckQuery, [id_habilidades]);

if (habilidadesCheckResult.rows.length !== id_habilidades.length) {
  const habilidadesEncontradas = habilidadesCheckResult.rows.map(h => h.id);
  const habilidadesInvalidas = id_habilidades.filter(h => !habilidadesEncontradas.includes(h));
  return res.status(400).json({
    success: false,
    error: 'INVALID_HABILIDADES',
    message: 'Uma ou mais habilidades nÃ£o existem',
    habilidades_invalidas: habilidadesInvalidas
  });
}
```

### Erro de Resposta

Se vocÃª enviar um `id_habilidades` que nÃ£o existe:

```json
{
  "success": false,
  "error": "INVALID_HABILIDADES",
  "message": "Uma ou mais habilidades nÃ£o existem",
  "habilidades_invalidas": [999, 1000]
}
```

### Fluxo Recomendado

1. **Buscar habilidades disponÃ­veis:** `GET /api/metas/habilidades-cargo/:id_cargo`
2. **Selecionar as habilidades:** Usar os IDs retornados
3. **Criar a meta:** `POST /api/metas` com os IDs validados

---

## ï¿½ğŸ“Š Impacto das AlteraÃ§Ãµes

| Aspecto | Antes | Depois |
|---------|-------|--------|
| **AssociaÃ§Ã£o Metas â†” Habilidades** | NÃ£o existia | Via tabela `meta_habilidades` |
| **Campos obrigatÃ³rios em `/api/metas`** | 7 | 8 (adicionado `id_habilidades`) |
| **Resposta de metas** | Sem info de habilidades | Inclui `habilidades_desenvolvidas` |
| **Resposta de habilidades** | Sem info de metas | Inclui `metas_associadas` |
| **IA Conhecimento de habilidades** | NÃ£o sabia que existiam | Sabe todos os IDs e nomes disponÃ­veis |
| **IA Retorno de habilidades** | NÃ£o retornava | Retorna `id_habilidades` por meta |
| **ValidaÃ§Ã£o de Habilidades** | N/A | Verifica se IDs existem antes de inserir |
| **Novo Endpoint para Listar Habilidades** | N/A | `GET /api/metas/habilidades-cargo/:id_cargo` |

---

## ğŸ”— Fluxo de IntegraÃ§Ã£o

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Frontend/Cliente                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”œâ”€â”€â†’ POST /api/ia/gerar-pdi
              â”‚    (sem id_habilidades, IA gera automaticamente)
              â”‚
              â”œâ”€â”€â†’ POST /api/metas (criaÃ§Ã£o manual)
              â”‚    (requer id_habilidades no body)
              â”‚
              â”œâ”€â”€â†’ GET /api/metas/usuario/:id
              â”‚    (retorna habilidades_desenvolvidas)
              â”‚
              â””â”€â”€â†’ GET /api/habilidades-usuarios/usuario/:id
                   (retorna metas_associadas)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Backend Controllers                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ metas.controller.js          (criarMeta)                 â”‚
â”‚ âœ“ metas.controller.js          (buscarMetasPorUsuario)      â”‚
â”‚ âœ“ ia.controller.js             (gerarPDI)                  â”‚
â”‚ âœ“ habilidades_usuarios.controller.js (buscarHabilidadesPorUsuario)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â””â”€â”€â†’ Queries SQL com JOINs em meta_habilidades
                   InserÃ§Ã£o em meta_habilidades (4 controllers)
                   Leitura com json_agg de habilidades/metas

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Banco de Dados Supabase PostgreSQL             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ metas_pdi â†â”€â”€â†’ meta_habilidades â†â”€â”€â†’ habilidades_cargo     â”‚
â”‚ usuarios  â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ meta_habilidades                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§ª Exemplos de RequisiÃ§Ãµes e Respostas

### Exemplo 1: Criar Meta com Habilidades

**Request:**
```bash
curl -X POST http://localhost:3000/api/metas \
  -H "Content-Type: application/json" \
  -d '{
    "id_usuario": 5,
    "titulo_da_meta": "Melhorar comunicaÃ§Ã£o em apresentaÃ§Ãµes",
    "atividades": [
      "Fazer curso de apresentaÃ§Ã£o executiva",
      "Praticar em reuniÃµes internas",
      "Apresentar para stakeholders"
    ],
    "data_vencimento": "2025-06-30",
    "status": "Em Progresso",
    "id_usuarios": [5],
    "resultado_3_meses": "Ter completado 50% do curso",
    "resultado_6_meses": "Dominar tÃ©cnicas de apresentaÃ§Ã£o",
    "observacao_gestor": "Foco em clareza e impacto",
    "id_habilidades": [1, 5]
  }'
```

**Response (201 Created):**
```json
{
  "success": true,
  "meta": {
    "id": 42,
    "id_usuario": 5,
    "titulo": "Melhorar comunicaÃ§Ã£o em apresentaÃ§Ãµes",
    "prazo": "2025-06-30",
    "status": "Em Progresso",
    "resultado_3_meses": "Ter completado 50% do curso",
    "resultado_6_meses": "Dominar tÃ©cnicas de apresentaÃ§Ã£o",
    "habilidades_desenvolvidas": [
      {
        "id": 1,
        "habilidade": "ComunicaÃ§Ã£o",
        "descricao": "Capacidade de se comunicar de forma clara e eficaz"
      },
      {
        "id": 5,
        "habilidade": "ApresentaÃ§Ãµes",
        "descricao": "Habilidade em apresentaÃ§Ãµes pÃºblicas"
      }
    ],
    "atividades": [
      {
        "id": 101,
        "titulo_atividade": "Fazer curso de apresentaÃ§Ã£o executiva",
        "status_atividade": "backlog"
      },
      {
        "id": 102,
        "titulo_atividade": "Praticar em reuniÃµes internas",
        "status_atividade": "backlog"
      },
      {
        "id": 103,
        "titulo_atividade": "Apresentar para stakeholders",
        "status_atividade": "backlog"
      }
    ]
  }
}
```

---

### Exemplo 2: Gerar PDI com IA (Novo Comportamento)

**Request:**
```bash
curl -X POST http://localhost:3000/api/ia/gerar-pdi \
  -H "Content-Type: application/json" \
  -d '{
    "id_user": 5,
    "descricao_usuario": "Desenvolvedor Senior em Java",
    "expectativas_gestor": "Melhorar habilidades de lideranÃ§a",
    "desafios": "Dificuldade em delegaÃ§Ã£o"
  }'
```

**Response (200 OK):**
```json
{
  "success": true,
  "id_user": 5,
  "pdi": [
    {
      "titulo": "Desenvolver lideranÃ§a atravÃ©s de mentoria",
      "atividades": [
        "Fazer curso de lideranÃ§a Ã¡gil",
        "Mentorizar 2 desenvolvedores juniors",
        "Participar de reuniÃµes de lideranÃ§a"
      ],
      "prazo": "2025-06-30",
      "status": "Em Progresso",
      "resultado_3_meses": "Mentoria iniciada com 2 juniors",
      "resultado_6_meses": "Juniors desenvolvidos, feedback positivo do time",
      "feedback_gestor": "Investir em desenvolvimento de lideranÃ§a",
      "id_habilidades": [3, 8]
    },
    {
      "titulo": "Aprimorar habilidades de comunicaÃ§Ã£o estratÃ©gica",
      "atividades": [
        "Fazer workshop de comunicaÃ§Ã£o executiva",
        "Apresentar roadmap tÃ©cnico mensalmente",
        "Melhorar documentaÃ§Ã£o de arquitetura"
      ],
      "prazo": "2025-06-30",
      "status": "Em Progresso",
      "resultado_3_meses": "Primeiras apresentaÃ§Ãµes executivas realizadas",
      "resultado_6_meses": "Ser referÃªncia em comunicaÃ§Ã£o tÃ©cnica",
      "feedback_gestor": "Aprimorar articulaÃ§Ã£o de ideias",
      "id_habilidades": [1]
    }
  ],
  "total_metas": 2,
  "gerado_por": "OpenAI GPT-4o-mini"
}
```

**Nota:** As metas agora automaticamente incluem `id_habilidades` gerados pela IA!

---

### Exemplo 3: Buscar Habilidades com Metas Associadas

**Request:**
```bash
curl -X GET http://localhost:3000/api/habilidades-usuarios/usuario/5 \
  -H "Authorization: Bearer seu_token"
```

**Response (200 OK):**
```json
{
  "success": true,
  "habilidades": [
    {
      "id": 1,
      "titulo": "ComunicaÃ§Ã£o",
      "descricao": "Capacidade de se comunicar de forma clara e eficaz",
      "nivel": 3,
      "created_at": "2024-01-15T10:30:00Z",
      "metas_associadas": [
        {
          "id": 42,
          "titulo": "Melhorar comunicaÃ§Ã£o em apresentaÃ§Ãµes",
          "prazo": "2025-06-30",
          "status": "Em Progresso",
          "resultado_3_meses": "Ter completado 50% do curso",
          "resultado_6_meses": "Dominar tÃ©cnicas de apresentaÃ§Ã£o"
        },
        {
          "id": 45,
          "titulo": "Aprimorar habilidades de comunicaÃ§Ã£o estratÃ©gica",
          "prazo": "2025-06-30",
          "status": "Em Progresso",
          "resultado_3_meses": "Primeiras apresentaÃ§Ãµes executivas realizadas",
          "resultado_6_meses": "Ser referÃªncia em comunicaÃ§Ã£o tÃ©cnica"
        }
      ]
    },
    {
      "id": 3,
      "titulo": "LideranÃ§a",
      "descricao": "Capacidade de liderar equipes",
      "nivel": 2,
      "created_at": "2024-01-20T14:45:00Z",
      "metas_associadas": [
        {
          "id": 43,
          "titulo": "Desenvolver lideranÃ§a atravÃ©s de mentoria",
          "prazo": "2025-06-30",
          "status": "Em Progresso",
          "resultado_3_meses": "Mentoria iniciada com 2 juniors",
          "resultado_6_meses": "Juniors desenvolvidos, feedback positivo do time"
        }
      ]
    }
  ],
  "total_habilidades": 2
}
```

---

## âš ï¸ ObservaÃ§Ãµes Importantes

### 1. **Retrocompatibilidade**

Se vocÃª tiver metas criadas **antes** desta atualizaÃ§Ã£o:
- Elas **nÃ£o terÃ£o habilidades associadas** automaticamente
- VocÃª pode usar a API de atualizaÃ§Ã£o (se implementada) para adicionar habilidades
- Ou podem ser deixadas como estÃ£o (sistema suporta metas sem habilidades)

### 2. **ValidaÃ§Ã£o de IDs de Habilidades**

O sistema **nÃ£o valida se os IDs de habilidades existem** no momento da criaÃ§Ã£o:
- Isso Ã© responsabilidade do frontend
- Recomenda-se sempre buscar primeiro as habilidades disponÃ­veis do cargo via outra API
- Se um ID invÃ¡lido for enviado, a inserÃ§Ã£o em `meta_habilidades` falharÃ¡ silenciosamente (apenas log de warn)

### 3. **Limite de Habilidades por Meta**

- **MÃ­nimo:** 1 habilidade por meta (obrigatÃ³rio)
- **MÃ¡ximo:** Sem limite (teoricamente ilimitado, mas recomenda-se 1-3 habilidades)
- A IA por padrÃ£o escolhe 1-3 habilidades por meta

### 4. **Metas sem Habilidades (MigraÃ§Ã£o)**

O sistema permite metas existentes sem habilidades:
- Queries retornam array vazio `"habilidades_desenvolvidas": []` ou `"metas_associadas": []`
- Novo campo Ã© sempre retornado, nunca null (seguranÃ§a em client-side)

### 5. **TransaÃ§Ãµes e Rollback**

Se a inserÃ§Ã£o de uma **meta** falhar, toda a transaÃ§Ã£o Ã© revertida:
- Metas nÃ£o criadas
- Habilidades nÃ£o vinculadas
- Atividades nÃ£o criadas
- Pessoas envolvidas nÃ£o vinculadas

Se a inserÃ§Ã£o de uma **habilidade especÃ­fica** falhar:
- Apenas aquela habilidade nÃ£o Ã© vinculada (log de warn)
- Meta Ã© criada normalmente
- Outras habilidades sÃ£o vinculadas com sucesso

---

## ğŸ” SeguranÃ§a e PermissÃµes

### ValidaÃ§Ãµes Implementadas

âœ… AutenticaÃ§Ã£o JWT obrigatÃ³ria  
âœ… ValidaÃ§Ã£o de array `id_habilidades` (nÃ£o nulo, nÃ£o vazio)  
âœ… ValidaÃ§Ã£o de tipos de dados (nÃºmeros inteiros para IDs)  
âœ… Foreign key constraints no banco de dados  
âœ… Logging de erros e warnings  

### RecomendaÃ§Ãµes

- âš ï¸ Validar no frontend se os IDs de habilidades pertencem ao cargo do usuÃ¡rio
- âš ï¸ Implementar permissÃµes: usuÃ¡rios sÃ³ veem suas prÃ³prias habilidades/metas
- âš ï¸ Implementar permissÃµes: gestores podem ver PDI dos subordinados
- âš ï¸ Considerar implementar auditoria de mudanÃ§as em meta_habilidades

---

## ğŸ“ Checklist de ImplementaÃ§Ã£o

- [x] Criar tabela `meta_habilidades` no banco de dados
- [x] Atualizar `metas.controller.js` - mÃ©todo `criarMeta`
- [x] Atualizar `metas.controller.js` - mÃ©todo `buscarMetasPorUsuario`
- [x] Atualizar `habilidades_usuarios.controller.js` - mÃ©todo `buscarHabilidadesPorUsuario`
- [x] Atualizar `ia.controller.js` - mÃ©todo `gerarPDI`
  - [x] Buscar habilidades do cargo
  - [x] Adicionar contexto de habilidades
  - [x] Atualizar system prompt
  - [x] Validar `id_habilidades` em pdiGerado
  - [x] Inserir em `meta_habilidades` ao salvar
- [x] **[v2.1]** Adicionar validaÃ§Ã£o de existÃªncia de habilidades antes de inserir
- [x] **[v2.1]** Criar novo endpoint `GET /api/metas/habilidades-cargo/:id_cargo`
- [x] **[v2.1]** Criar guia detalhado de teste (GUIA_TESTE_METAS_HABILIDADES.md)
- [ ] Criar/atualizar testes unitÃ¡rios
- [ ] Testar fluxo completo ponta-a-ponta
- [ ] Atualizar documentaÃ§Ã£o Swagger/OpenAPI
- [ ] Comunicar mudanÃ§a ao time frontend
- [ ] Migrar dados existentes (se necessÃ¡rio)

---

## ğŸš€ PrÃ³ximas Melhorias Sugeridas

1. **Endpoint de AtualizaÃ§Ã£o:** `PUT /api/metas/:id` para atualizar habilidades de uma meta existente
2. **Endpoint de ExclusÃ£o:** `DELETE /api/meta-habilidades/:id` para desassociar habilidade de meta
3. **ValidaÃ§Ã£o Frontend:** Lista de habilidades disponÃ­veis por cargo
4. **Dashboard:** Visualizar metas por habilidade sendo desenvolvida
5. **RelatÃ³rios:** AnÃ¡lise de quais habilidades tÃªm mais metas associadas
6. **IA Melhorada:** Feedback loop para melhorar sugestÃµes de habilidades

---

## ğŸ“ Suporte e DÃºvidas

Para dÃºvidas sobre esta atualizaÃ§Ã£o:

1. Consulte este documento
2. Revise o cÃ³digo dos controllers modificados
3. Verifique os logs de erro no console
4. Teste com os exemplos fornecidos acima

---

**VersÃ£o:** 2.1  
**Data:** Janeiro 2026  
**Status:** âœ… Implementado com ValidaÃ§Ãµes Aprimoradas  
**PrÃ³xima RevisÃ£o:** Conforme feedback e testes
